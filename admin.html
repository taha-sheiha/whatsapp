<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CountaNeura - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 900px) {
            .admin-layout {
                grid-template-columns: 350px 1fr;
            }
        }

        input[type="text"],
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.8rem 1rem;
            color: white;
            font-size: 0.95rem;
            margin-bottom: 1.2rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .content-card {
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .content-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .action-btns {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
            border-top: 1px solid var(--glass-border);
            padding-top: 1rem;
        }

        .btn-small {
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #be123c);
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #f87171, #be123c);
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-edit {
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #34d399, #047857);
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
        }

        #content-category {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: white;
        }

        #content-category option {
            background: var(--bg-dark);
            color: white;
        }

        /* Sentiment Badges */
        .badge-sentiment {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
        }

        .sentiment-calm {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .sentiment-angry {
            background: rgba(220, 38, 38, 0.4);
            color: #fca5a5;
            font-weight: 800;
            border: 1px solid #ef4444;
        }

        .sentiment-confused {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .sentiment-unclear {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .sentiment-neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Status Pills */
        .status-pill {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-right: 5px;
            text-transform: uppercase;
        }

        .pill-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .pill-paused {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .pill-closed {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(107, 114, 128, 0.4);
        }

        .sentiment-alert {
            border: 2px solid #ef4444 !important;
            background: rgba(127, 29, 29, 0.4) !important;
            animation: pulse-urgent 1.5s infinite;
        }

        @keyframes pulse-urgent {
            0% {
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                border-color: #ef4444;
            }

            50% {
                opacity: 0.6;
                border-color: transparent;
            }

            100% {
                opacity: 1;
                border-color: #ef4444;
            }
        }

        /* Modal & Session Styles */
        #history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-body {
            background: var(--bg-dark);
            width: 90%;
            max-width: 900px;
            height: 90vh;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        #history-modal.fullscreen .modal-body {
            width: 98vw;
            height: 98vh;
            max-width: none;
            border-radius: 12px;
        }

        .history-scroll {
            flex: 1;
            overflow-y: auto;
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
        }

        .session-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.2rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .session-card:hover {
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.07);
            transform: scale(1.01);
        }

        .status-pill {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .pill-paused {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .pill-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .fullscreen-inbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 900;
            background: var(--bg-dark);
            padding: 2rem;
            max-width: 100% !important;
            margin: 0 !important;
        }
    </style>
</head>

<body>
    <div style="max-width: 1200px; margin: 2rem auto; padding: 1rem; width: 100%;">
        <!-- Admin Header -->
        <header class="chat-header"
            style="margin-bottom: 2rem; border-bottom: 2px solid var(--accent); padding-bottom: 1rem;">
            <div class="header-logo-group">
                <img src="logo.png" alt="CountaNeura Logo" class="brand-logo" onerror="this.style.display='none'">
                <div>
                    <h1 class="brand-title" style="font-size: 1.8rem;">CountaNeura Dashboard</h1>
                    <p class="brand-subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø­ÙŠØ© (Live AI Control)</p>
                </div>
            </div>
        </header>

        <!-- Admin Tabs -->
        <div
            style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
            <button class="btn btn-primary" id="tab-kb">ğŸ“š Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
            <button class="btn btn-outline" id="tab-chats">ğŸ’¬ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button>
            <button class="btn btn-outline" id="tab-settings">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡</button>
            <button class="btn btn-outline" id="tab-webhooks">ğŸ“¡ Webhook</button>
            <button class="btn btn-outline" id="tab-usage">ğŸ“Š Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</button>
        </div>

        <!-- SECTION 1: Knowledge Base -->
        <div id="section-kb" class="admin-layout">
            <!-- Sidebar / Form -->
            <div class="glass-card" style="align-self: start;">
                <h3
                    style="margin-bottom: 1.5rem; color: var(--primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                    Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ØµØ±</h3>
                <form id="content-form">
                    <input type="hidden" id="content-id">

                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ</label>
                    <select id="content-category" required>
                        <option value="service" selected>ğŸ¯ Ø®Ø¯Ù…Ø§ØªÙ†Ø§ (Services)</option>
                        <option value="plan">ğŸ’° Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Pricing Plans)</option>
                        <option value="feature">âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨ÙˆØª (Features)</option>
                        <option value="faq">â“ Ø£Ø³Ø¦Ù„Ø© Ø´Ø§Ø¦Ø¹Ø© (FAQ)</option>
                        <option value="contact">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ (Contact)</option>
                    </select>

                    <div id="group-title">
                        <label id="lbl-title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù…Ø³Ù…Ù‰</label>
                        <input type="text" id="content-title" required
                            placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ù‚Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">
                    </div>

                    <div id="group-desc">
                        <label id="lbl-desc">Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙˆØª)</label>
                        <textarea id="content-description" rows="5"
                            placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„ØªÙŠ Ø³ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ø¨ÙˆØª ÙˆÙŠØ±Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„ÙŠÙ‡Ø§..."></textarea>
                    </div>

                    <div id="group-extra">
                        <label id="lbl-extra">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø®ÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="content-extra" placeholder="Ù…Ø«Ø§Ù„: $500/mo, +2010...">
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; justify-content: center;">Ø­ÙØ¸ ÙÙŠ
                            Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</button>
                        <button type="button" class="btn btn-danger" id="btn-cancel"
                            style="display:none; flex: 1; justify-content: center;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                    </div>
                </form>
            </div>

            <!-- Content Grid -->
            <div class="glass-card" style="min-height: 500px;">
                <h3
                    style="margin-bottom: 1.5rem; color: var(--secondary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                    Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div id="loading" class="loading-indicator"
                    style="display: flex; justify-content: center; margin: 2rem 0;">
                    <span style="color:var(--accent)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                    <div class="dot-typing"></div>
                </div>
                <div id="content-list"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    <!-- Items Output -->
                </div>
            </div>
        </div>

        <!-- SECTION 2: Live Chats -->
        <div id="section-chats" style="display: none;">
            <div class="glass-card" id="inbox-card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                    <h3 style="color: var(--secondary);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø­ÙŠØ© (Sessions Manager)</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-small btn-outline" id="toggle-full" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">ğŸ”²</button>
                        <button class="btn btn-small btn-secondary" id="refresh-logs">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ”„</button>
                    </div>
                </div>

                <div id="logs-container"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; max-height: 70vh; overflow-y: auto; padding: 10px;">
                    <!-- Sessions injected here -->
                </div>
            </div>
        </div>

        <!-- SECTION 6: Unified Settings & Accounts -->
        <div id="section-settings" style="display: none;">
            <!-- Row 1: AI Prompt -->
            <div class="glass-card" style="margin-bottom: 2rem;">
                <h3
                    style="margin-bottom: 1.5rem; color: var(--primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                    ğŸ§  Ù‚ÙˆØ§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ "Ù†ÙŠÙˆØ±Ø§" (AI Personality)</h3>
                <form id="settings-form">
                    <label>Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØµØ§Ø±Ù…Ø©</label>
                    <p style="font-size: 0.75rem; opacity: 0.6; margin-bottom: 10px;">Ù‡Ù†Ø§ Ø¨ØªÙƒØªØ¨ "Ø±ÙˆØ­" Ø§Ù„Ø¨ÙˆØªØŒ Ø¥Ø²Ø§ÙŠ ÙŠØ¨ÙŠØ¹ØŒ
                        Ø¥Ø²Ø§ÙŠ ÙŠØªÙƒÙ„Ù…ØŒ ÙˆØ¥ÙŠÙ‡ Ø­Ø¯ÙˆØ¯Ù‡.</p>
                    <textarea id="setting-ai-prompt"
                        style="height: 300px; font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; line-height: 1.5;"></textarea>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                        <div>
                            <label>Telegram Bot Token ğŸ“±</label>
                            <input type="text" id="setting-tg-token" placeholder="ØªÙˆÙƒÙ† ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ù† BotFather">
                        </div>
                        <div>
                            <label>WhatsApp Phone Number ID ğŸ“</label>
                            <input type="text" id="setting-wa-phone-id" placeholder="Phone ID Ù…Ù† Meta Developers">
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.8rem 2rem;">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                            ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ âœ¨</button>
                    </div>
                </form>
            </div>

            <!-- Row 2: Meta Accounts Integration -->
            <div class="admin-layout" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <!-- Link New Meta Page -->
                <div class="glass-card">
                    <h3
                        style="margin-bottom: 1.5rem; color: var(--secondary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                        ğŸ”— Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ Meta Ø¬Ø¯ÙŠØ¯ (FB/IG)</h3>
                    <form id="meta-form">
                        <label>Ø§Ù„Ù…Ù†ØµØ©</label>
                        <select id="meta-platform"
                            style="width:100%; padding:0.8rem; background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); border-radius:10px; color:white; margin-bottom:1.2rem;">
                            <option value="facebook">Messenger (ÙÙŠØ³Ø¨ÙˆÙƒ)</option>
                            <option value="instagram">Instagram Direct (Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…)</option>
                        </select>

                        <label>ID Ø§Ù„Ø­Ø³Ø§Ø¨ (Page ID)</label>
                        <input type="text" id="meta-page-id" required placeholder="Ù…Ø«Ø§Ù„: 61587829233932">

                        <label>Access Token</label>
                        <textarea id="meta-token" required placeholder="Ø§Ù„ØµÙ‚ Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ù‡Ù†Ø§..."
                            style="width:100%; min-height:80px;"></textarea>

                        <label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ØªØ¹Ø±ÙŠÙ</label>
                        <input type="text" id="meta-name" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡">

                        <button type="submit" class="btn btn-primary"
                            style="width: 100%; justify-content: center; background: var(--secondary);">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø¢Ù†
                            ğŸš€</button>
                    </form>
                </div>

                <!-- Linked Accounts List -->
                <div class="glass-card">
                    <h3
                        style="margin-bottom: 1.5rem; color: var(--accent); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                        ğŸ“‘ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                    <div id="meta-list" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Linked pages list -->
                        <p style="opacity: 0.5; text-align: center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 5: Webhook Logs -->
        <div id="section-webhooks" style="display: none;">
            <div class="glass-card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                    <h3 style="color: var(--secondary);">Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù€ Webhook (ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„)</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-small btn-primary" id="test-webhook">ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø±Ø§Ø¨Ø· (Test) ğŸ› ï¸</button>
                        <button class="btn btn-small btn-secondary" id="refresh-webhooks">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ğŸ”„</button>
                    </div>
                </div>
                <div id="webhook-logs-list"
                    style="max-height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    <!-- Logs injection -->
                </div>
            </div>
        </div>

        <!-- SECTION 3: API Usage -->
        <div id="section-usage" style="display: none;">
            <div class="glass-card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                    <h3 style="color: var(--secondary);">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù€ API ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-small btn-accent" id="btn-reset-usage">ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ğŸ—‘ï¸</button>
                        <button class="btn btn-small btn-secondary" id="refresh-usage">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ğŸ”„</button>
                    </div>
                </div>
                <div id="usage-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: right;">
                        <thead style="background: rgba(255,255,255,0.05);">
                            <tr>
                                <th style="padding: 12px; border-bottom: 1px solid var(--glass-border);">API Key (Last
                                    4)</th>
                                <th style="padding: 12px; border-bottom: 1px solid var(--glass-border);">Model ID</th>
                                <th style="padding: 12px; border-bottom: 1px solid var(--glass-border);">Ù†Ø¬Ø§Ø­ âœ…</th>
                                <th style="padding: 12px; border-bottom: 1px solid var(--glass-border);">ÙØ´Ù„ âŒ</th>
                                <th style="padding: 12px; border-bottom: 1px solid var(--glass-border);">Error Log (Ø¢Ø®Ø±
                                    Ø®Ø·Ø£)</th>
                                <th style="padding: 12px; border-bottom: 1px solid var(--glass-border);">Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usage-list">
                            <!-- Stats injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Conversation Manager (Modal) -->
    <div id="history-modal">
        <div class="modal-body">
            <div
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                <h3 id="modal-title" style="color: var(--primary); margin: 0;">Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
                <div id="modal-controls" style="display: flex; gap: 8px;">
                    <!-- Controls injected JS -->
                </div>
            </div>

            <div id="history-content" class="history-scroll"></div>
            <div id="ai-summary-box" style="display:none; margin: 10px 0;"></div>

            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="modal-reply-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯ ÙŠØ¯ÙˆÙŠ Ù…Ø¨Ø§Ø´Ø±..."
                    style="margin-bottom:0; flex:1;">
                <button class="btn btn-small" style="background: var(--secondary);" id="modal-send-btn">Ø¥Ø±Ø³Ø§Ù„
                    ğŸ“©</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = 'https://ai.tahasheiha.workers.dev';

        // KB LOGIC
        const form = document.getElementById('content-form');
        const listContainer = document.getElementById('content-list');
        const loader = document.getElementById('loading');
        const btnCancel = document.getElementById('btn-cancel');
        const idField = document.getElementById('content-id');
        const catField = document.getElementById('content-category');
        const titleField = document.getElementById('content-title');
        const descField = document.getElementById('content-description');
        const extraField = document.getElementById('content-extra');

        function resetForm() {
            idField.value = ''; titleField.value = '';
            descField.value = ''; extraField.value = '';
            btnCancel.style.display = 'none';
            catField.dispatchEvent(new Event('change'));
        }
        btnCancel.onclick = resetForm;

        function updateFormUI() {
            const cat = catField.value;
            const groups = { title: document.getElementById('group-title'), desc: document.getElementById('group-desc'), extra: document.getElementById('group-extra') };
            const labels = { title: document.getElementById('lbl-title'), desc: document.getElementById('lbl-desc'), extra: document.getElementById('lbl-extra') };

            Object.values(groups).forEach(g => g.style.display = 'block');
            titleField.required = true; descField.required = true; extraField.required = false;

            if (cat === 'service' || cat === 'feature') {
                labels.title.innerText = 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'; labels.desc.innerText = 'Ø§Ù„ØªÙØ§ØµÙŠÙ„'; groups.extra.style.display = 'none';
            } else if (cat === 'plan') {
                labels.title.innerText = 'Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©'; labels.desc.innerText = 'Ø§Ù„Ù…Ø²Ø§ÙŠØ§'; labels.extra.innerText = 'Ø§Ù„Ø³Ø¹Ø±';
            } else if (cat === 'faq') {
                labels.title.innerText = 'Ø§Ù„Ø³Ø¤Ø§Ù„'; labels.desc.innerText = 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'; groups.extra.style.display = 'none';
            } else if (cat === 'contact') {
                labels.title.innerText = 'Ø§Ù„Ø§Ø³Ù…'; labels.extra.innerText = 'Ø§Ù„Ø±Ù‚Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„'; groups.desc.style.display = 'none'; descField.required = false; extraField.required = true;
            }
        }
        catField.addEventListener('change', updateFormUI);
        updateFormUI();

        async function fetchContent() {
            loader.style.display = 'flex';
            listContainer.innerHTML = '';
            try {
                const res = await fetch(`${API_URL}/content`);
                const data = await res.json();
                if (data.length === 0) { listContainer.innerHTML = '<p style="opacity:0.5; grid-column:1/-1; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>'; return; }
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'content-card';
                    card.innerHTML = `
                        <div>
                            <div class="card-badge">${item.category}</div>
                            <h4 style="margin-top:1.5rem; color:#fff;">${item.title}</h4>
                            <p style="font-size:0.8rem; margin:1rem 0; opacity:0.8;">${item.description || ''}</p>
                            ${item.extra_data ? `<small style="display:block; color:var(--accent)">${item.extra_data}</small>` : ''}
                        </div>
                        <div class="action-btns">
                            <button class="btn btn-small btn-edit" onclick='editItem(${JSON.stringify(item)})'>ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-small btn-danger" onclick="deleteItem('${item.id}')">Ù…Ø³Ø­</button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            } catch (e) { listContainer.innerHTML = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.'; }
            loader.style.display = 'none';
        }

        window.editItem = (item) => {
            idField.value = item.id; catField.value = item.category;
            titleField.value = item.title; descField.value = item.description;
            extraField.value = item.extra_data; btnCancel.style.display = 'block';
            updateFormUI(); window.scrollTo(0, 0);
        };

        window.deleteItem = async (id) => {
            if (!confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø­ØŸ")) return;
            await fetch(`${API_URL}/content?id=${id}`, { method: 'DELETE' });
            fetchContent();
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const payload = { id: idField.value, category: catField.value, title: titleField.value, description: descField.value, extra_data: extraField.value };
            await fetch(`${API_URL}/content`, { method: 'POST', body: JSON.stringify(payload) });
            resetForm(); fetchContent();
        };

        // CHAT SESSION LOGIC
        const sectionKb = document.getElementById('section-kb');
        const sectionChats = document.getElementById('section-chats');
        const sectionWebhooks = document.getElementById('section-webhooks');
        const sectionUsage = document.getElementById('section-usage');
        const sectionSettings = document.getElementById('section-settings');

        const tabKb = document.getElementById('tab-kb');
        const tabChats = document.getElementById('tab-chats');
        const tabWebhooks = document.getElementById('tab-webhooks');
        const tabUsage = document.getElementById('tab-usage');
        const tabSettings = document.getElementById('tab-settings');

        const logsContainer = document.getElementById('logs-container');
        const usageList = document.getElementById('usage-list');
        const btnRefreshLogs = document.getElementById('refresh-logs');
        const btnRefreshUsage = document.getElementById('refresh-usage');
        let currentModalChatId = null;

        function switchTab(target) {
            sectionKb.style.display = target === 'kb' ? 'grid' : 'none';
            sectionChats.style.display = target === 'chats' ? 'block' : 'none';
            sectionWebhooks.style.display = target === 'webhooks' ? 'block' : 'none';
            sectionUsage.style.display = target === 'usage' ? 'block' : 'none';
            sectionSettings.style.display = target === 'settings' ? 'block' : 'none';

            tabKb.className = target === 'kb' ? 'btn btn-primary' : 'btn btn-outline';
            tabChats.className = target === 'chats' ? 'btn btn-secondary' : 'btn btn-outline';
            tabWebhooks.className = target === 'webhooks' ? 'btn btn-accent' : 'btn btn-outline';
            tabUsage.className = target === 'usage' ? 'btn btn-accent' : 'btn btn-outline';
            tabSettings.className = target === 'settings' ? 'btn btn-primary' : 'btn btn-outline';

            // Reset background inline styles since we now use classes
            [tabKb, tabChats, tabWebhooks, tabUsage, tabSettings].forEach(t => t.style.background = '');

            if (target === 'chats') fetchSessions();
            if (target === 'usage') fetchUsageStats();
            if (target === 'webhooks') fetchWebhookLogs();
            if (target === 'settings') { fetchSettings(); fetchMetaPages(); }
        }

        tabKb.onclick = () => switchTab('kb');
        tabChats.onclick = () => switchTab('chats');
        tabWebhooks.onclick = () => switchTab('webhooks');
        tabUsage.onclick = () => switchTab('usage');
        tabSettings.onclick = () => switchTab('settings');
        btnRefreshUsage.onclick = fetchUsageStats;

        document.getElementById('btn-reset-usage').onclick = async () => {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§ÙƒØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ù€ API.")) return;
            try {
                await fetch(`${API_URL}/admin/usage-stats`, { method: 'DELETE' });
                fetchUsageStats();
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙÙŠØ±."); }
        };

        // META LOGIC
        const metaForm = document.getElementById('meta-form');
        const metaList = document.getElementById('meta-list');

        metaForm.onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                page_id: document.getElementById('meta-page-id').value,
                platform: document.getElementById('meta-platform').value,
                access_token: document.getElementById('meta-token').value,
                page_name: document.getElementById('meta-name').value
            };
            try {
                const res = await fetch(`${API_URL}/register-page`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    alert("ØªÙ… Ø±Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
                    metaForm.reset();
                    fetchMetaPages();
                } else {
                    alert("ÙØ´Ù„ Ø§Ù„Ø±Ø¨Ø·ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                }
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙŠØ±ÙƒØ±."); }
        };

        async function fetchMetaPages() {
            metaList.innerHTML = '<p style="opacity:0.5;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
            try {
                const res = await fetch(`${API_URL}/admin/pages`); // Note: We need this endpoint in worker
                const pages = await res.json();
                metaList.innerHTML = '';
                if (!pages.length) { metaList.innerHTML = '<p style="opacity:0.5;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙØ­Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©.</p>'; return; }
                pages.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'content-card';
                    card.style.padding = '1rem';
                    card.innerHTML = `
                        <div style="font-weight:bold; color:var(--primary);">${p.page_name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
                        <div style="font-size:0.7rem; opacity:0.6; margin:5px 0;">ID: ${p.page_id}</div>
                        <div style="font-size:0.6rem; color:var(--accent);">${p.platform.toUpperCase()}</div>
                    `;
                    metaList.appendChild(card);
                });
            } catch (e) { metaList.innerHTML = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.'; }
        }

        async function fetchUsageStats() {
            try {
                usageList.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; opacity:0.5;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
                const res = await fetch(`${API_URL}/admin/usage-stats`);
                const stats = await res.json();
                renderUsageStats(stats);
            } catch (e) {
                console.error("fetchUsageStats failed:", e);
                usageList.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--danger);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.</td></tr>';
            }
        }

        // SETTINGS LOGIC
        const settingsForm = document.getElementById('settings-form');
        async function fetchSettings() {
            try {
                const res = await fetch(`${API_URL}/admin/settings`);
                const data = await res.json();
                const fields = {
                    'setting-ai-prompt': data.ai_prompt,
                    'setting-tg-token': data.tg_token,
                    'setting-wa-phone-id': data.wa_phone_id
                };
                for (const [id, val] of Object.entries(fields)) {
                    const el = document.getElementById(id);
                    if (el) el.value = val || '';
                }
            } catch (e) { console.error("fetchSettings Error:", e); alert("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª."); }
        }

        settingsForm.onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                ai_prompt: document.getElementById('setting-ai-prompt').value,
                tg_token: document.getElementById('setting-tg-token').value,
                wa_phone_id: document.getElementById('setting-wa-phone-id').value
            };
            try {
                const res = await fetch(`${API_URL}/admin/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! âœ¨");
                else alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.");
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„."); }
        };

        function renderUsageStats(stats) {
            usageList.innerHTML = '';
            if (!stats.length) { usageList.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; opacity:0.5;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø¨Ø¹Ø¯.</td></tr>'; return; }
            stats.forEach(s => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--glass-border)';
                row.innerHTML = `
                    <td style="padding: 12px; font-family: monospace;">****${s.key_last4}</td>
                    <td style="padding: 12px; color: var(--secondary);">${s.model_id}</td>
                    <td style="padding: 12px; color: #22c55e; font-weight: bold;">${s.success_count}</td>
                    <td style="padding: 12px; color: #ef4444;">${s.error_count}</td>
                    <td style="padding: 12px; font-size: 0.75rem; color: #ff9494; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${s.last_error_log || ''}">${s.last_error_log || '-'}</td>
                    <td style="padding: 12px; font-size: 0.8rem; opacity: 0.7;">${new Date(s.last_used_at).toLocaleString('ar-EG')}</td>
                `;
                usageList.appendChild(row);
            });
        }

        async function fetchSessions() {
            try {
                const res = await fetch(`${API_URL}/admin/sessions`);
                const sessions = await res.json();
                renderSessions(sessions);
                if (currentModalChatId) viewHistory(currentModalChatId, true);
            } catch (e) { }
        }

        function renderSessions(sessions) {
            logsContainer.innerHTML = '';
            if (!sessions.length) { logsContainer.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.5;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª.</p>'; return; }
            sessions.forEach(s => {
                const card = document.createElement('div');
                let platformIcon = 'ğŸŒ';
                if (s.platform === 'telegram') platformIcon = 'ğŸ“±';
                else if (s.platform === 'facebook' || s.platform === 'messenger') platformIcon = 'ğŸ”µ';
                else if (s.platform === 'instagram') platformIcon = 'ğŸ“¸';
                else if (s.platform === 'whatsapp') platformIcon = 'ğŸŸ¢';

                const sentimentClass =
                    s.sentiment === 'Ù…Ù†ÙØ¹Ù„' ? 'sentiment-angry' :
                        (s.sentiment === 'Ø­ÙŠØ±Ø§Ù†' ? 'sentiment-confused' :
                            (s.sentiment === 'Ù…Ø´ ÙØ§Ù‡Ù…' ? 'sentiment-unclear' :
                                (s.sentiment === 'Ù‡Ø§Ø¯ÙŠØ¡' ? 'sentiment-calm' : 'sentiment-neutral')));

                const isUrgent = s.needs_intervention || s.sentiment === 'Ù…Ù†ÙØ¹Ù„';
                card.className = 'session-card ' + (isUrgent ? 'sentiment-alert' : '');
                card.onclick = () => viewHistory(s.chat_id);
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:0.6rem; opacity:0.6; margin-bottom:10px;">
                        <span>${platformIcon} ${s.platform.toUpperCase()} <span class="status-pill ${s.status === 'paused' ? 'pill-paused' : (s.status === 'closed' ? 'pill-closed' : 'pill-active')}">${s.status}</span></span>
                        <span>${new Date(s.updated_at).toLocaleTimeString('ar-EG')}</span>
                    </div>
                    <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">${s.user_name || 'User'}</div>
                    <div style="font-size:0.8rem; opacity:0.8; height:40px; overflow:hidden;">${s.last_msg}</div>
                    <div style="margin-top:10px;">
                        <span class="badge-sentiment ${sentimentClass}">${s.sentiment || 'Ù‡Ø§Ø¯ÙŠØ¡'}</span>
                        ${isUrgent ? '<span class="badge-sentiment sentiment-angry">ğŸ”¥ ØªØ¯Ø®Ù„ Ø¹Ø§Ø¬Ù„</span>' : ''}
                    </div>
                `;
                logsContainer.appendChild(card);
            });
        }

        window.viewHistory = async (chatId, silent = false) => {
            currentModalChatId = chatId;
            const modal = document.getElementById('history-modal');
            const historyContent = document.getElementById('history-content');
            const controls = document.getElementById('modal-controls');
            const summaryBox = document.getElementById('ai-summary-box');
            if (!silent) {
                modal.style.display = 'flex';
                historyContent.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
                summaryBox.style.display = 'none';
                summaryBox.innerHTML = '';
            }

            try {
                const logsRes = await fetch(`${API_URL}/admin/logs`);
                const logs = await logsRes.json();
                const sessionLogs = logs.filter(l => l.chat_id === chatId).reverse();

                const sessionRes = await fetch(`${API_URL}/admin/sessions`);
                const session = (await sessionRes.json()).find(s => s.chat_id === chatId);

                controls.innerHTML = `
                    <button class="btn btn-small" style="background:#6d28d9" onclick="summarizeUser('${chatId}')" title="ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¹Ù…ÙŠÙ„">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ğŸ§ </button>
                    <button class="btn btn-small" style="background:#4b5563" onclick="document.getElementById('history-modal').classList.toggle('fullscreen')" title="ØªÙƒØ¨ÙŠØ±">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                        </svg>
                    </button>
                    <button class="btn btn-small" style="background:${session?.status === 'paused' ? 'var(--secondary)' : '#f59e0b'}" onclick="updateStatus('${chatId}','${session?.status === 'paused' ? 'resume' : 'pause'}')">${session?.status === 'paused' ? 'ØªØ´ØºÙŠÙ„ AI' : 'Ø¥ÙŠÙ‚Ø§Ù AI'}</button>
                    <button class="btn btn-small btn-danger" onclick="updateStatus('${chatId}','close')">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn btn-small" style="background:rgba(255,255,255,0.08); border:1px solid var(--glass-border);" onclick="document.getElementById('history-modal').style.display='none'; document.getElementById('history-modal').classList.remove('fullscreen'); currentModalChatId=null;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        Ø®Ø±ÙˆØ¬
                    </button>
                `;

                historyContent.innerHTML = '';
                sessionLogs.forEach(l => {
                    // User message
                    if (l.user_msg) {
                        const userRow = document.createElement('div');
                        userRow.style.cssText = `display:flex; align-items:flex-end; gap:8px; justify-content:flex-start; margin-bottom:12px; animation:fadeIn 0.3s ease;`;
                        userRow.innerHTML = `
                            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#0ea5e9);display:flex;align-items:center;justify-content:center;font-size:0.85rem;flex-shrink:0;">ğŸ‘¤</div>
                            <div style="background:rgba(255,255,255,0.06);border:1px solid var(--glass-border);border-right:3px solid #22d3ee;padding:10px 14px;border-radius:20px 20px 20px 4px;max-width:78%;font-size:0.9rem;line-height:1.6;color:var(--text);">${l.user_msg}</div>
                        `;
                        historyContent.appendChild(userRow);
                    }
                    // AI reply
                    if (l.ai_msg && !l.is_human) {
                        const aiRow = document.createElement('div');
                        aiRow.style.cssText = `display:flex; align-items:flex-end; gap:8px; justify-content:flex-end; margin-bottom:12px; animation:fadeIn 0.3s ease;`;
                        aiRow.innerHTML = `
                            <div style="background:linear-gradient(135deg,#4f46e5,#0ea5e9);padding:10px 14px;border-radius:20px 20px 4px 20px;max-width:78%;font-size:0.9rem;line-height:1.6;color:#fff;">${l.ai_msg}</div>
                            <div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;font-size:0.85rem;flex-shrink:0;">ğŸ¤–</div>
                        `;
                        historyContent.appendChild(aiRow);
                    }
                    // Human agent reply
                    if (l.human_reply) {
                        const hrRow = document.createElement('div');
                        hrRow.style.cssText = `display:flex; align-items:flex-end; gap:8px; justify-content:flex-end; margin-bottom:12px; animation:fadeIn 0.3s ease;`;
                        hrRow.innerHTML = `
                            <div style="background:rgba(168,85,247,0.15);border:1px solid rgba(168,85,247,0.4);padding:10px 14px;border-radius:20px 20px 4px 20px;max-width:78%;font-size:0.9rem;line-height:1.6;color:#e9d5ff;">${l.human_reply}</div>
                            <div style="width:32px;height:32px;border-radius:50%;background:rgba(168,85,247,0.2);border:1px solid rgba(168,85,247,0.5);display:flex;align-items:center;justify-content:center;font-size:0.85rem;flex-shrink:0;">ğŸ‘¨â€ğŸ’¼</div>
                        `;
                        historyContent.appendChild(hrRow);
                    }
                });
                if (!silent) historyContent.scrollTop = historyContent.scrollHeight;
            } catch (e) { }
        };

        window.updateStatus = async (chatId, action) => {
            await fetch(`${API_URL}/admin/session-control`, { method: 'POST', body: JSON.stringify({ chatId, action }) });
            if (action === 'close') { document.getElementById('history-modal').style.display = 'none'; currentModalChatId = null; }
            fetchSessions();
        };

        document.getElementById('modal-send-btn').onclick = async () => {
            const input = document.getElementById('modal-reply-input');
            const msg = input.value.trim();
            if (!msg || !currentModalChatId) return;
            const resLogs = await fetch(`${API_URL}/admin/logs`);
            const lastLog = (await resLogs.json()).find(l => l.chat_id === currentModalChatId);
            await fetch(`${API_URL}/admin/reply`, { method: 'POST', body: JSON.stringify({ logId: lastLog.id, reply: msg }) });
            input.value = ''; viewHistory(currentModalChatId, true);
        };

        document.getElementById('toggle-full').onclick = () => document.getElementById('section-chats').classList.toggle('fullscreen-inbox');
        window.summarizeUser = async (chatId) => {
            const summaryDiv = document.getElementById('ai-summary-box');
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = '<div style="text-align:center; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px dashed var(--primary);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ£Ù‡Ø¯Ø§ÙÙ‡... ğŸ§ </div>';

            try {
                const res = await fetch(`${API_URL}/admin/summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatId })
                });
                const data = await res.json();
                summaryDiv.innerHTML = `
                    <div style="background:rgba(109,40,217,0.15); border-left:4px solid var(--primary); padding:15px; border-radius:8px; font-size:0.9rem; border:1px solid rgba(109,40,217,0.3); position:relative;">
                        <button onclick="document.getElementById('ai-summary-box').style.display='none'" 
                                style="position:absolute; top:8px; left:8px; background:transparent; border:none; color:rgba(255,255,255,0.5); cursor:pointer; font-size:1.1rem;" title="Ø¥Ø®ÙØ§Ø¡">âœ•</button>
                        <div style="font-weight:bold; margin-bottom:10px; color:var(--primary); display:flex; align-items:center; gap:8px;">
                            <span style="font-size:1.2rem;">ğŸ“Š</span> ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
                        </div>
                        <div style="white-space:pre-wrap; line-height:1.6; color:rgba(255,255,255,0.9);">${data.summary}</div>
                    </div>
                `;
            } catch (e) {
                summaryDiv.innerHTML = '<div style="color:#ef4444; padding:10px; text-align:center;">ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</div>';
            }
        };

        async function fetchWebhookLogs() {
            const list = document.getElementById('webhook-logs-list');
            if (!list) return;
            list.innerHTML = '<p style="opacity:0.5;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>';
            try {
                const res = await fetch(`${API_URL}/admin/webhook-logs`);
                const logs = await res.json();
                list.innerHTML = '';
                if (!logs.length) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; border:1px dashed var(--glass-border); border-radius:10px; opacity:0.6;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ù…Ù† ÙÙŠØ³Ø¨ÙˆÙƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Webhook Subscriptions ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†.</div>';
                    return;
                }
                logs.forEach(l => {
                    const item = document.createElement('div');
                    item.style.padding = '10px';
                    item.style.background = 'rgba(255,255,255,0.05)';
                    item.style.borderRadius = '8px';
                    item.style.fontSize = '0.75rem';
                    item.innerHTML = `
                        <div style="color:var(--accent); margin-bottom:5px;">${new Date(l.created_at).toLocaleString('ar-EG')}</div>
                        <pre style="white-space:pre-wrap; background:rgba(0,0,0,0.3); padding:8px; border-radius:4px; font-family:monospace;">${JSON.stringify(JSON.parse(l.payload), null, 2)}</pre>
                    `;
                    list.appendChild(item);
                });
            } catch (e) { list.innerHTML = 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.'; }
        }

        const btnRefreshWebhooks = document.getElementById('refresh-webhooks');
        if (btnRefreshWebhooks) btnRefreshWebhooks.onclick = fetchWebhookLogs;

        const btnTestWebhook = document.getElementById('test-webhook');
        if (btnTestWebhook) {
            btnTestWebhook.onclick = async () => {
                if (!confirm("Ù‡Ù†Ø¨Ø¹Øª Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆÙ‡Ù…ÙŠØ© Ù†Ø®ØªØ¨Ø± Ø¨ÙŠÙ‡Ø§ Ø§Ù„Ø³ÙŠØ³ØªÙ….. Ù…ÙˆØ§ÙÙ‚ØŸ")) return;
                try {
                    const res = await fetch(`${API_URL}/webhook`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            object: "page",
                            entry: [{
                                id: "test_page_id",
                                messaging: [{
                                    sender: { id: "test_user_id" },
                                    message: { text: "Hello from Debugger!" }
                                }]
                            }]
                        })
                    });
                    if (res.ok) {
                        alert("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØ¨Ø¹Øª! Ø§Ø³ØªÙ†Ù‰ Ø«Ø§Ù†ÙŠØ© ÙˆØ¯ÙˆØ³ 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„' ÙˆØ´ÙˆÙ Ù‡ÙŠØ¸Ù‡Ø± ÙˆÙ„Ø§ Ù„Ø£.");
                        if (typeof fetchWebhookLogs === 'function') fetchWebhookLogs();
                    } else {
                        alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: " + res.status);
                    }
                } catch (e) {
                    console.error("Test Webhook Error:", e);
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.message);
                }
            };
        }

        fetchContent();
        setInterval(() => { if (sectionChats.style.display === 'block') fetchSessions(); }, 8000);
    </script>
</body>

</html>